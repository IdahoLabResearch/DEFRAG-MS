
# -*- coding: utf-8 -*-
"""
Smoothed Propylene Rate vs. Propane Concentration
Author: kristy-sci 
Copyright 2026, Battelle Energy Alliance, LLC, ALL RIGHTS RESERVED
"""

import os
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from scipy import integrate
from scipy.signal import savgol_filter
from scipy.stats import linregress
from matplotlib.pyplot import cm
from matplotlib.ticker import FuncFormatter

# === USER CONFIGURATION ===
path = R"C:\Users\KRISST\OneDrive - Idaho National Laboratory\Desktop\Cedar\Ga_May\redo_for_paper\h2\code_git"  # Folder containing flux_*.csv files

cat_ratio = 0.5
r = 2 / 1000  # m
d = r * 2
nmol = 10
mol = 10 / (10**9)
eb = 0.4
L = 39.2 / 1000  # m
cross_sectional_area = np.pi * d**2
units_c = mol / (eb * cross_sectional_area * L)

# === FILE HANDLING ===
files = sorted([f for f in os.listdir(path) if f.startswith("flux_knud") and f.endswith(".csv")],
               key=lambda f: int(f.split("knud")[1].split(".")[0]))

colors = cm.plasma(np.linspace(0, 1, len(files)))
tick_labels = [0, 100000, 200000, 300000, 400000, 500000]
fit_parameters = []
active_sites = []

fig, ax = plt.subplots(figsize=(10, 6))

for idx, file in enumerate(files):
    df = pd.read_csv(os.path.join(path, file))
    df['time'] = np.arange(0, 5.997, 0.001)

    # === Average AMU columns ===
    base_columns = ['2', '15', '18', '26', '28', '29', '30', '40', '41', '44']
    averaged = {col: df[[c for c in df.columns if c.startswith(col)]].mean(axis=1) for col in base_columns}
    averaged_df = pd.DataFrame(averaged)
    averaged_df['time'] = df['time']

    # === Background subtraction ===
    bkg = averaged_df.iloc[0:1].mean()
    averaged_df = averaged_df - bkg.values
    averaged_df['time'] = df['time']
    averaged_df = averaged_df.drop(index=[0, 1, 2, 3, 4, 5])

    times = averaged_df['time'].to_numpy()

    # === Propane Concentration ===
    flux = averaged_df['29'].to_numpy()
    time_scalar_c = -(1 - cat_ratio**2) / 6
    time_multiplier_c = np.concatenate([[0], times[1:]**time_scalar_c])
    concentration = flux * time_multiplier_c
    concentration *= integrate.simps(flux, times) / integrate.simps(concentration, times)
    concentration *= units_c * 100

    # === Propylene Rate ===
    pflux = averaged_df['41'].to_numpy()
    original_m0p = integrate.simps(pflux, times)
    time_scalar_p = -(1 - cat_ratio**2) * 1.5
    time_multiplier_p = np.concatenate([[0], times[1:]**time_scalar_p])
    prate = pflux * time_multiplier_p
    prate[0] = 0
    prate *= original_m0p / integrate.simps(prate, times) * (-time_scalar_p)

    ptp = times[np.argmax(pflux)]
    pD = (1 / 6) * (eb * L**2) / ptp
    punits = nmol * pD / (eb * L**2)
    prate *= punits

    # === Apply Savitzky-Golay smoothing ===
    window_length = 11
    polyorder = 3
    if len(concentration) >= window_length:
        smoothed_conc = savgol_filter(concentration, window_length, polyorder)
        smoothed_prate = savgol_filter(prate, window_length, polyorder)
    else:
        smoothed_conc = concentration
        smoothed_prate = prate

    # === Fit first N points ===
    fit_range = 150
    x = smoothed_conc[:fit_range]
    y = smoothed_prate[:fit_range]
    slope, intercept, _, _, _ = linregress(x, y)

    # === Estimate active sites ===
    R0 = np.mean(y) * 1e-9  # mol/s/g_cat
    C0 = np.mean(x)         # mol/m³
    k0 = slope              # m³/mol/s
    N = R0 / (k0 * C0) if k0 != 0 else np.nan
    active_sites.append(N)

    # === Fit again with intercept = 0 ===
    max_idx = np.argmax(smoothed_conc)
    x = smoothed_conc[:max_idx]
    y = smoothed_prate[:max_idx]
    k0 = np.sum(x * y) / np.sum(x**2)
    slope = k0
    intercept = 0.0
    fit_parameters.append((idx + 1, slope, intercept))

    # === Recalculate N with forced zero intercept ===
    R0 = np.mean(y) * 1e-9
    C0 = np.mean(x)
    N = R0 / (k0 * C0) if k0 != 0 else np.nan
    active_sites[-1] = N

    # === Plot ===
    ax.plot(smoothed_conc, smoothed_prate, marker='x', color=colors[idx])
    x_fit = np.linspace(min(smoothed_prate), max(smoothed_prate), 100)
    y_fit = slope * x_fit + intercept
    ax.plot(x_fit, y_fit, linestyle='--', color=colors[idx])

# === Colorbar ===
sm = plt.cm.ScalarMappable(cmap=cm.plasma, norm=plt.Normalize(vmin=0, vmax=1))
sm.set_array([])
cbar = plt.colorbar(sm, ticks=np.linspace(0, 1, 6))
cbar.ax.set_yticklabels(tick_labels)
cbar.ax.set_title('Propane Pulsed [nmols]', fontsize=14)
formatter = FuncFormatter(lambda x, pos: f'{tick_labels[pos]:.1e}')
cbar.ax.yaxis.set_major_formatter(formatter)

# === Labels and Save ===
plt.xlabel('Propane Concentration [$10^2$ mol/$m^3$]', fontsize=14)
plt.ylabel('Propylene Formation Rate [nmol/s $g_{cat}$]', fontsize=14)
plt.tight_layout()
plt.savefig(os.path.join(path, "propylene_vs_propane_concentration_fit.png"))
plt.show()

# === Print Table ===
print("\nEstimated Active Sites for Propylene Formation (from smoothed fits):")
print(f"{'Fit #':<6}{'Slope':<10}{'Intercept':<12}{'Active Sites (mol/g_cat)':<28}")
for i, (fit_num, slope, intercept) in enumerate(fit_parameters):
    print(f"{fit_num:<6}{slope:<10.4f}{intercept:<12.4f}{active_sites[i]:<28.2e}")
